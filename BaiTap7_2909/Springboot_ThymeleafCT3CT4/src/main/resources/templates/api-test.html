<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>API Test - CRUD Operations</title>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script>var contextPath = ""</script>
    <script src="/js/admin.js"></script>
    <script src="/js/test-pages.js"></script>
    <link rel="stylesheet" href="/css/api-test-enhanced.css">
</head>
<body>
    <div layout:fragment="content">
        <div class="api-test-container">
            <div class="container-fluid">
                <div class="api-header fade-in">
                    <h1><i class="fas fa-code me-3"></i>API Test Center</h1>
                    <p>Test và quản lý CRUD operations cho Category và Product</p>
                </div>
                
                <!-- Statistics Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stats-card slide-in-left">
                            <div class="stats-number" id="categoryCount">-</div>
                            <div class="stats-label">Categories</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card slide-in-left" style="animation-delay: 0.1s;">
                            <div class="stats-number" id="productCount">-</div>
                            <div class="stats-label">Products</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card slide-in-right" style="animation-delay: 0.2s;">
                            <div class="stats-number" id="activeProducts">-</div>
                            <div class="stats-label">Active Products</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card slide-in-right" style="animation-delay: 0.3s;">
                            <div class="stats-number" id="totalValue">-</div>
                            <div class="stats-label">Total Value (VND)</div>
                        </div>
                    </div>
                </div>
            
                <!-- Category Management -->
                <div class="row">
                    <div class="col-lg-6">
                        <div class="api-card slide-in-left">
                            <div class="api-card-header">
                                <h6><i class="fas fa-folder"></i>Category Management</h6>
                            </div>
                            <div class="api-card-body">
                                <button class="api-btn mb-3" onclick="showCreateNewCategoryModal()">
                                    <i class="fas fa-plus me-2"></i>Thêm Category
                                </button>
                                
                                <div class="table-responsive">
                                    <table class="table api-table" id="categoryTable">
                                        <thead>
                                            <tr>
                                                <th><i class="fas fa-hashtag me-1"></i>ID</th>
                                                <th><i class="fas fa-image me-1"></i>Icon</th>
                                                <th><i class="fas fa-tag me-1"></i>Name</th>
                                                <th><i class="fas fa-cogs me-1"></i>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Category data will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Product Management -->
                    <div class="col-lg-6">
                        <div class="api-card slide-in-right">
                            <div class="api-card-header">
                                <h6><i class="fas fa-box"></i>Product Management</h6>
                            </div>
                            <div class="api-card-body">
                                <button class="api-btn mb-3" onclick="showCreateNewProductModal()">
                                    <i class="fas fa-plus me-2"></i>Thêm Product
                                </button>
                                
                                <div class="table-responsive">
                                    <table class="table api-table" id="productTable">
                                        <thead>
                                            <tr>
                                                <th><i class="fas fa-hashtag me-1"></i>ID</th>
                                                <th><i class="fas fa-image me-1"></i>Image</th>
                                                <th><i class="fas fa-tag me-1"></i>Name</th>
                                                <th><i class="fas fa-dollar-sign me-1"></i>Price</th>
                                                <th><i class="fas fa-folder me-1"></i>Category</th>
                                                <th><i class="fas fa-cogs me-1"></i>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Product data will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
        
        <!-- Enhanced Category Modal -->
        <div class="modal fade" id="createCategoryModal" tabindex="-1" role="dialog" aria-labelledby="createCategoryModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content" style="border-radius: 20px; border: none; box-shadow: 0 20px 40px rgba(0,0,0,0.15);">
                    <form id="addCategory" method="post" onsubmit="return false;" enctype="multipart/form-data">
                        <div class="modal-header" style="background: linear-gradient(135deg, #4e73df 0%, #224abe 100%); color: white; border-radius: 20px 20px 0 0; border: none;">
                            <h5 class="modal-title" id="createCategoryModalLabel">
                                <i class="fas fa-plus-circle me-2"></i>Thêm Category Mới
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body" style="padding: 2rem;">
                            <div class="mb-3">
                                <label for="new_categoryname" class="form-label fw-bold">
                                    <i class="fas fa-tag me-2 text-primary"></i>Tên Category
                                </label>
                                <input type="text" class="form-control form-control-lg" id="new_categoryname" name="categoryName" 
                                       placeholder="Nhập tên category..." required style="border-radius: 10px; border: 2px solid #e3e6f0; transition: all 0.3s ease;">
                            </div>
                            <div class="mb-3">
                                <label for="new_icon" class="form-label fw-bold">
                                    <i class="fas fa-image me-2 text-primary"></i>Icon Category
                                </label>
                                <input type="file" class="form-control form-control-lg" id="new_icon" name="icon" 
                                       accept="image/*" style="border-radius: 10px; border: 2px solid #e3e6f0; transition: all 0.3s ease;">
                                <div class="form-text">Chọn file ảnh cho icon category (JPG, PNG, GIF)</div>
                            </div>
                        </div>
                        <div class="modal-footer" style="border: none; padding: 1.5rem 2rem;">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 10px; padding: 0.75rem 1.5rem;">
                                <i class="fas fa-times me-2"></i>Hủy
                            </button>
                            <button type="submit" class="btn btn-primary" style="border-radius: 10px; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #4e73df 0%, #224abe 100%); border: none;">
                                <i class="fas fa-save me-2"></i>Thêm Category
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Update Category Modal -->
        <div class="modal" tabindex="-1" role="dialog" id="updateCategoryInfoModal">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Update Category</h5>
                        <button type="button" class="close" data-dismiss="modal">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="far fa-address-card mr-1"></i>Category</h5>
                            </div>
                            <div class="card-body pb-0">
                                <p id="updateCategoryInfoModalId"></p>
                                <p id="updateCategoryInfoModalName"></p>
                                <p id="updateCategoryInfoModalIcon"></p>
                            </div>
                        </div>
                        <div class="card mt-2">
                            <div class="card-header">
                                <h5><i class="far fa-address-card mr-1"></i>Update Category</h5>
                            </div>
                            <div class="card-body pb-0">
                                <form id="updateCategory" method="post" onsubmit="return false;" enctype="multipart/form-data">
                                    <div class="form-group">
                                        <label for="categoryName">Category Name</label>
                                        <input type="text" class="form-control" id="categoryName_up" name="categoryName">
                                    </div>
                                    <div class="form-group">
                                        <label for="new_icon">Icon</label>
                                        <input type="file" class="form-control" id="icon_up" name="icon">
                                    </div>
                                    <input type="hidden" id="categoryId_up" name="categoryId">
                                    <div class="form-group row">
                                        <div class="col text-center">
                                            <button type="submit" class="btn btn-primary btn-block">Cập nhật</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Product Modal -->
        <div class="modal" tabindex="-1" role="dialog" id="createProductModal">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <form id="addProduct" method="post" onsubmit="return false;" enctype="multipart/form-data">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Product</h5>
                            <button type="button" class="close" data-dismiss="modal">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="productName">Product Name</label>
                                        <input type="text" class="form-control" id="productName" name="productName" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="unitPrice">Unit Price</label>
                                        <input type="number" class="form-control" id="unitPrice" name="unitPrice" step="0.01" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="discount">Discount</label>
                                        <input type="number" class="form-control" id="discount" name="discount" step="0.01" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label for="quantity">Quantity</label>
                                        <input type="number" class="form-control" id="quantity" name="quantity" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="categoryId">Category</label>
                                        <select class="form-control" id="categoryId" name="categoryId" required>
                                            <option value="">Select Category</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="status">Status</label>
                                        <select class="form-control" id="status" name="status" required>
                                            <option value="1">Active</option>
                                            <option value="0">Inactive</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="description">Description</label>
                                <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="imageFile">Product Image</label>
                                <input type="file" class="form-control" id="imageFile" name="imageFile" required>
                            </div>
                            <div class="form-group row">
                                <div class="col text-center">
                                    <button type="submit" class="btn btn-primary btn-block">Add Product</button>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <script type="text/javascript">
        // Global variables
        let categories = [];
        let products = [];
        
        $(document).ready(function() {
            // Initialize page
            initializePage();
            
            // Load data
            loadCategories();
            loadProducts();
            loadCategoryOptions();
            
            // Setup form handlers
            setupFormHandlers();
            
            // Setup event listeners
            setupEventListeners();
        });
        
        function initializePage() {
            // Add loading states
            showLoadingState();
            
            // Initialize tooltips
            $('[data-bs-toggle="tooltip"]').tooltip();
            
            // Add form validation styles
            addFormValidationStyles();
        }
        
        function showLoadingState() {
            $('#categoryCount, #productCount, #activeProducts, #totalValue').html('<div class="loading-spinner"></div>');
        }
        
        function addFormValidationStyles() {
            // Add focus effects to form inputs
            $('.form-control').on('focus', function() {
                $(this).css('border-color', '#4e73df');
                $(this).css('box-shadow', '0 0 0 0.2rem rgba(78, 115, 223, 0.25)');
            }).on('blur', function() {
                $(this).css('border-color', '#e3e6f0');
                $(this).css('box-shadow', 'none');
            });
        }
        
        // Enhanced Load Categories
        function loadCategories() {
            $.getJSON(contextPath + '/api/category', function(json) {
                categories = json;
                var tbody = $('#categoryTable tbody');
                tbody.empty();
                
                if (json.length === 0) {
                    tbody.append(`
                        <tr>
                            <td colspan="4" class="empty-state">
                                <i class="fas fa-folder-open"></i>
                                <h5>Chưa có category nào</h5>
                                <p>Hãy thêm category đầu tiên!</p>
                            </td>
                        </tr>
                    `);
                } else {
                    for (var i = 0; i < json.length; i++) {
                        var row = `
                            <tr class="fade-in" style="animation-delay: ${i * 0.1}s;">
                                <td><span class="badge bg-primary">${json[i].id}</span></td>
                                <td>
                                    <img src="/uploads/${json[i].image}" style="width:50px; height:50px; object-fit: cover;" 
                                         class="img-fluid rounded" alt="Category Icon" 
                                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yNSAyNUMzMC41MjI4IDI1IDM1IDIwLjUyMjggMzUgMTVDMzUgOS40NzcxNSAzMC41MjI4IDUgMjUgNUMxOS40NzcyIDUgMTUgOS40NzcxNSAxNSAxNUMxNSAyMC41MjI4IDE5LjQ3NzIgMjUgMjUgMjVaIiBmaWxsPSIjOUNBM0FGIi8+CjxwYXRoIGQ9Ik0yNSAzMEMzMC41MjI4IDMwIDM1IDI1LjUyMjggMzUgMjBDMzUgMTQuNDc3MiAzMC41MjI4IDEwIDI1IDEwQzE5LjQ3NzIgMTAgMTUgMTQuNDc3MiAxNSAyMEMxNSAyNS41MjI4IDE5LjQ3NzIgMzAgMjUgMzBaIiBmaWxsPSIjNjM3RUVBIi8+Cjwvc3ZnPgo='">
                                </td>
                                <td><strong>${json[i].name}</strong></td>
                                <td>
                                    <button class="action-btn btn-edit" data-id="${json[i].id}" data-name="${json[i].name}" data-icon="${json[i].image}" 
                                            data-bs-toggle="tooltip" title="Chỉnh sửa category">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="action-btn btn-delete" data-id="${json[i].id}" 
                                            data-bs-toggle="tooltip" title="Xóa category">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                        tbody.append(row);
                    }
                }
                
                // Update statistics
                updateStatistics();
            }).fail(function() {
                showAlert('error', 'Không thể tải danh sách categories');
                $('#categoryTable tbody').html(`
                    <tr>
                        <td colspan="4" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>Lỗi khi tải dữ liệu
                        </td>
                    </tr>
                `);
            });
        }
        
        // Enhanced Load Products
        function loadProducts() {
            $.getJSON(contextPath + '/api/product', function(json) {
                products = json;
                var tbody = $('#productTable tbody');
                tbody.empty();
                
                if (json.length === 0) {
                    tbody.append(`
                        <tr>
                            <td colspan="6" class="empty-state">
                                <i class="fas fa-box-open"></i>
                                <h5>Chưa có product nào</h5>
                                <p>Hãy thêm product đầu tiên!</p>
                            </td>
                        </tr>
                    `);
                } else {
                    for (var i = 0; i < json.length; i++) {
                        var row = `
                            <tr class="fade-in" style="animation-delay: ${i * 0.1}s;">
                                <td><span class="badge bg-success">${json[i].productId}</span></td>
                                <td>
                                    <img src="/uploads/${json[i].images}" style="width:50px; height:50px; object-fit: cover;" 
                                         class="img-fluid rounded" alt="Product Image" 
                                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yNSAyNUMzMC41MjI4IDI1IDM1IDIwLjUyMjggMzUgMTVDMzUgOS40NzcxNSAzMC41MjI4IDUgMjUgNUMxOS40NzcyIDUgMTUgOS40NzcxNSAxNSAxNUMxNSAyMC41MjI4IDE5LjQ3NzIgMjUgMjUgMjVaIiBmaWxsPSIjOUNBM0FGIi8+CjxwYXRoIGQ9Ik0yNSAzMEMzMC41MjI4IDMwIDM1IDI1LjUyMjggMzUgMjBDMzUgMTQuNDc3MiAzMC41MjI4IDEwIDI1IDEwQzE5LjQ3NzIgMTAgMTUgMTQuNDc3MiAxNSAyMEMxNSAyNS41MjI4IDE5LjQ3NzIgMzAgMjUgMzBaIiBmaWxsPSIjNjM3RUVBIi8+Cjwvc3ZnPgo='">
                                </td>
                                <td><strong>${json[i].productName}</strong></td>
                                <td><span class="badge bg-info">${formatCurrency(json[i].unitPrice)}</span></td>
                                <td><span class="badge bg-secondary">${json[i].category ? json[i].category.name : 'N/A'}</span></td>
                                <td>
                                    <button class="action-btn btn-delete" data-id="${json[i].productId}" 
                                            data-bs-toggle="tooltip" title="Xóa product">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                        tbody.append(row);
                    }
                }
                
                // Update statistics
                updateStatistics();
            }).fail(function() {
                showAlert('error', 'Không thể tải danh sách products');
                $('#productTable tbody').html(`
                    <tr>
                        <td colspan="6" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>Lỗi khi tải dữ liệu
                        </td>
                    </tr>
                `);
            });
        }
        
        // Update Statistics
        function updateStatistics() {
            $('#categoryCount').text(categories.length);
            $('#productCount').text(products.length);
            
            let activeProducts = products.filter(p => p.status === 1).length;
            $('#activeProducts').text(activeProducts);
            
            let totalValue = products.reduce((sum, p) => sum + (p.unitPrice * p.quantity), 0);
            $('#totalValue').text(formatCurrency(totalValue));
        }
        
        // Format Currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }
        
        // Show Alert
        function showAlert(type, message) {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';
            
            const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 9999; min-width: 300px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <i class="fas ${icon} me-2"></i>${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            // Remove existing alerts
            $('.alert').remove();
            
            // Add new alert
            $('body').append(alertHtml);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                $('.alert').fadeOut();
            }, 5000);
        }
        
        // Load Category Options for Product Form
        function loadCategoryOptions() {
            $.getJSON(contextPath + '/api/category', function(json) {
                var select = $('#categoryId');
                select.empty();
                select.append('<option value="">Chọn Category</option>');
                
                for (var i = 0; i < json.length; i++) {
                    select.append('<option value="' + json[i].id + '">' + json[i].name + '</option>');
                }
            });
        }
        
        // Setup Form Handlers
        function setupFormHandlers() {
            // Add Category Form
            $("form#addCategory").submit(function(e) {
                e.preventDefault();
                var formData = new FormData(this);
                var submitBtn = $(this).find('button[type="submit"]');
                
                // Add loading state
                submitBtn.html('<div class="loading-spinner me-2"></div>Đang thêm...');
                submitBtn.prop('disabled', true);
                
                $.ajax({
                    url: contextPath + '/api/category/addCategory',
                    type: 'POST',
                    dataType: "json",
                    data: formData,
                    success: function (data) {
                        showAlert('success', 'Category đã được thêm thành công!');
                        $('#createCategoryModal').modal('hide');
                        loadCategories();
                        loadCategoryOptions();
                        $("form#addCategory")[0].reset();
                    },
                    error: function(xhr, status, error) {
                        showAlert('error', 'Lỗi khi thêm category: ' + (xhr.responseJSON ? xhr.responseJSON.message : error));
                    },
                    complete: function() {
                        // Reset button state
                        submitBtn.html('<i class="fas fa-save me-2"></i>Thêm Category');
                        submitBtn.prop('disabled', false);
                    },
                    cache: false,
                    contentType: false,
                    processData: false
                });
            });
        }
        
        // Setup Event Listeners
        function setupEventListeners() {
            // Edit Category
            $(document).on('click', '.btn-edit', function() {
                var id = $(this).data('id');
                var name = $(this).data('name');
                var icon = $(this).data('icon');
                
                $('#updateCategoryInfoModalId')[0].innerText = "Category ID: " + id;
                $('#updateCategoryInfoModalName')[0].innerText = "Category Name: " + name;
                $('#updateCategoryInfoModalIcon')[0].innerText = 'Icon: ' + icon;
                $('#categoryName_up')[0].value = name;
                $('#categoryId_up')[0].value = id;
                $('#updateCategoryInfoModal').modal('show');
            });
            
            // Delete Category
            $(document).on('click', '.btn-delete', function() {
                var id = $(this).data('id');
                var isProduct = $(this).closest('table').attr('id') === 'productTable';
                
                if (isProduct) {
                    deleteProduct(id);
                } else {
                    deleteCategory(id);
                }
            });
        }
        
        // Delete Category
        function deleteCategory(id) {
            if (confirm('Bạn có chắc chắn muốn xóa category này?')) {
                $.ajax({
                    type: "DELETE",
                    url: contextPath + '/api/category/deleteCategory?categoryId=' + id,
                    dataType: "json",
                    success: function() {
                        showAlert('success', 'Category đã được xóa thành công!');
                        loadCategories();
                        loadCategoryOptions();
                    },
                    error: function(xhr, status, error) {
                        showAlert('error', 'Lỗi khi xóa category: ' + (xhr.responseJSON ? xhr.responseJSON.message : error));
                    }
                });
            }
        }
        
        // Delete Product
        function deleteProduct(id) {
            if (confirm('Bạn có chắc chắn muốn xóa product này?')) {
                $.ajax({
                    type: "DELETE",
                    url: contextPath + '/api/product/deleteProduct?productId=' + id,
                    dataType: "json",
                    success: function() {
                        showAlert('success', 'Product đã được xóa thành công!');
                        loadProducts();
                    },
                    error: function(xhr, status, error) {
                        showAlert('error', 'Lỗi khi xóa product: ' + (xhr.responseJSON ? xhr.responseJSON.message : error));
                    }
                });
            }
        }
        
        // Show Create Category Modal
        function showCreateNewCategoryModal() {
            $('#new_categoryname')[0].value = '';
            $('#new_icon')[0].value = '';
            $('#createCategoryModal').modal('show');
        }
        
        // Show Create Product Modal
        function showCreateNewProductModal() {
            $('#addProduct')[0].reset();
            loadCategoryOptions();
            $('#createProductModal').modal('show');
        }
        
        // Add Product Form Handler
        $("form#addProduct").submit(function(e) {
            e.preventDefault();
            var formData = new FormData(this);
            var submitBtn = $(this).find('button[type="submit"]');
            
            // Add loading state
            submitBtn.html('<div class="loading-spinner me-2"></div>Đang thêm...');
            submitBtn.prop('disabled', true);
            
            $.ajax({
                url: contextPath + '/api/product/addProduct',
                type: 'POST',
                dataType: "json",
                data: formData,
                success: function (data) {
                    showAlert('success', 'Product đã được thêm thành công!');
                    $('#createProductModal').modal('hide');
                    loadProducts();
                    $("form#addProduct")[0].reset();
                },
                error: function(xhr, status, error) {
                    showAlert('error', 'Lỗi khi thêm product: ' + (xhr.responseJSON ? xhr.responseJSON.message : error));
                },
                complete: function() {
                    // Reset button state
                    submitBtn.html('<i class="fas fa-save me-2"></i>Thêm Product');
                    submitBtn.prop('disabled', false);
                },
                cache: false,
                contentType: false,
                processData: false
            });
        });
        
        // Update Category Form Handler
        $("form#updateCategory").submit(function(e) {
            e.preventDefault();
            var formData = new FormData(this);
            var submitBtn = $(this).find('button[type="submit"]');
            
            // Add loading state
            submitBtn.html('<div class="loading-spinner me-2"></div>Đang cập nhật...');
            submitBtn.prop('disabled', true);
            
            $.ajax({
                url: contextPath + '/api/category/updateCategory',
                type: 'PUT',
                dataType: "json",
                data: formData,
                success: function (data) {
                    showAlert('success', 'Category đã được cập nhật thành công!');
                    $('#updateCategoryInfoModal').modal('hide');
                    loadCategories();
                    loadCategoryOptions();
                },
                error: function(xhr, status, error) {
                    showAlert('error', 'Lỗi khi cập nhật category: ' + (xhr.responseJSON ? xhr.responseJSON.message : error));
                },
                complete: function() {
                    // Reset button state
                    submitBtn.html('<i class="fas fa-save me-2"></i>Cập nhật');
                    submitBtn.prop('disabled', false);
                },
                cache: false,
                contentType: false,
                processData: false
            });
        });
        
        // Add smooth scrolling for better UX
        function smoothScrollTo(element) {
            $('html, body').animate({
                scrollTop: $(element).offset().top - 100
            }, 1000);
        }
        
        // Add keyboard shortcuts
        $(document).keydown(function(e) {
            // Ctrl + N for new category
            if (e.ctrlKey && e.keyCode === 78) {
                e.preventDefault();
                showCreateNewCategoryModal();
            }
            
            // Ctrl + P for new product
            if (e.ctrlKey && e.keyCode === 80) {
                e.preventDefault();
                showCreateNewProductModal();
            }
            
            // Escape to close modals
            if (e.keyCode === 27) {
                $('.modal').modal('hide');
            }
        });
        
        // Add auto-refresh functionality
        function autoRefresh() {
            setTimeout(function() {
                loadCategories();
                loadProducts();
                autoRefresh();
            }, 30000); // Refresh every 30 seconds
        }
        
        // Start auto-refresh
        autoRefresh();
    </script>
</body>
</html>
